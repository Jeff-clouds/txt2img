<!-- Version 1.4 -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. ç”Ÿæˆå›¾ç‰‡-2.é•¿æŒ‰å›¾ç‰‡ä¿å­˜</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8778257573911049"
     crossorigin="anonymous"></script>
    <link rel="stylesheet" href="styles/shared.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        function detectDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || window.innerWidth <= 768;
            
            // å¦‚æœæ˜¯æ¡Œé¢è®¾å¤‡ä¸”å½“å‰åœ¨mobile.htmlï¼Œåˆ™è·³è½¬åˆ°index.html
            if (!isMobile && window.location.pathname.includes('mobile.html')) {
                // è·å–å½“å‰ä»“åº“çš„åŸºç¡€URL
                const baseUrl = window.location.href.split('/').slice(0, -1).join('/');
                window.location.href = `${baseUrl}/index.html`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æµ‹
        window.addEventListener('load', detectDevice);

        // ç›‘å¬æ–‡æœ¬å˜åŒ–ï¼Œè°ƒæ•´å®¹å™¨é«˜åº¦å’Œæ›´æ–°å­—æ•°ç»Ÿè®¡
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            updateStats();
        }
    </script>
</head>
<body>
    <div id="mainPage">
        <div class="button-area">
            <div class="settings-area">
                <div class="input-group">
                    <label for="emojiInput">è¡¨æƒ…ç¬¦å·:</label>
                    <input type="text" id="emojiInput" value="ğŸ± ğŸ± ğŸ± ğŸ± ğŸ±" placeholder="è¾“å…¥è¡¨æƒ…ç¬¦å·">
                </div>
                <div class="input-group">
                    <label for="watermarkInput">æ°´å°æ–‡æœ¬:</label>
                    <input type="text" id="watermarkInput" value="æ°´å°" placeholder="è¾“å…¥æ°´å°æ–‡æœ¬">
                </div>
            </div>
            <div class="button-group">
                <button class="preview-btn" onclick="previewMarkdown()">é¢„è§ˆæ¸²æŸ“æ•ˆæœ</button>
                <button class="generate-btn" onclick="generateImage()" style="display: none;">ç”Ÿæˆå›¾ç‰‡</button>
                <a href="pages/about.html" style="color: #8b949e; text-decoration: none; margin-left: 20px;">å…³äº</a>
                <a href="pages/split-mobile.html" style="color: #8b949e; text-decoration: none; margin-left: 20px;">é•¿å›¾åˆ†å‰²</a>
            </div>
        </div>
        <div class="content-area">
            <div class="content-wrapper">
                <div class="emoji-container">
                    <span class="emoji">ğŸ±</span>
                    <span class="emoji">ğŸ±</span>
                    <span class="emoji">ğŸ±</span>
                    <span class="emoji">ğŸ±</span>
                    <span class="emoji">ğŸ±</span>
                </div>
                <div class="card">
                    <div class="timestamp"></div>
                    <div class="card-text" contenteditable="true">æ­£æ–‡</div>
                    <div class="rendered-content" style="display: none;"></div>
                    <div class="stats"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="imagePage">
        <div class="save-hint">ğŸ‘‡é•¿æŒ‰ä¸‹æ–¹å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†ŒğŸ‘‡</div>
        <img class="generated-image" />
    </div>

    <script>
        // ç›‘å¬æ–‡æœ¬å˜åŒ–ï¼Œè°ƒæ•´å®¹å™¨é«˜åº¦å’Œæ›´æ–°å­—æ•°ç»Ÿè®¡
        document.querySelector('.card-text').addEventListener('input', function() {
            adjustHeight();
            updateStats();
        });
        
        function updateTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.querySelector('.timestamp').textContent = `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°æ—¶é—´æˆ³
        updateTimestamp();
        
        function adjustHeight() {
            const mainPage = document.getElementById('mainPage');
            const contentHeight = document.querySelector('.content-wrapper').offsetHeight;
            mainPage.style.height = `${contentHeight + 100}px`; // é¢å¤–æ·»åŠ ä¸€äº›paddingç©ºé—´
        }

        // æ›´æ–° emoji æ˜¾ç¤º
        document.getElementById('emojiInput').addEventListener('input', function() {
            const emoji = this.value.trim().split(/\s+/)[0]; // åªå–ç¬¬ä¸€ä¸ªemoji
            const emojiContainer = document.querySelector('.emoji-container');
            // é‡å¤5æ¬¡
            emojiContainer.innerHTML = Array(5).fill(`<span class="emoji">${emoji}</span>`).join('');
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ°´å°
        window.addEventListener('load', function() {
            updateStats();
        });

        // å¤„ç†å¤šä½™çš„ç©ºè¡Œ
        function normalizeEmptyLines(element) {
            // é€’å½’å¤„ç†æ‰€æœ‰å­å…ƒç´ 
            function processNode(node) {
                // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå»é™¤è¿ç»­çš„æ¢è¡Œ
                if (node.nodeType === Node.TEXT_NODE) {
                    node.textContent = node.textContent.replace(/\n{3,}/g, '\n\n');
                    return;
                }

                // å¤„ç†å—çº§å…ƒç´ ä¹‹é—´çš„é—´è·
                if (node.nodeType === Node.ELEMENT_NODE) {
                    const style = window.getComputedStyle(node);
                    // å¦‚æœæ˜¯å—çº§å…ƒç´ ä¸”åªåŒ…å«ç©ºç™½
                    if (style.display === 'block' && node.textContent.trim() === '' && 
                        !node.querySelector('img, hr, br')) {
                        node.remove();
                        return;
                    }

                    // ç‰¹æ®Šå¤„ç†åˆ—è¡¨é¡¹
                    if (node.tagName === 'LI') {
                        // ç§»é™¤åˆ—è¡¨é¡¹å†…çš„ç©ºæ®µè½
                        const emptyParagraphs = node.querySelectorAll('p:empty, p:only-child');
                        emptyParagraphs.forEach(p => {
                            if (p.textContent.trim() === '') {
                                p.remove();
                            }
                        });
                    }

                    // ç§»é™¤æ‰€æœ‰å—çº§å…ƒç´ çš„è¾¹è·è®¾ç½®
                    if (node.tagName === 'P' || node.tagName === 'UL' || node.tagName === 'OL' || 
                        style.display === 'block') {
                        node.style.margin = '0';
                    }
                }

                // é€’å½’å¤„ç†å­å…ƒç´ 
                Array.from(node.childNodes).forEach(processNode);
            }

            // å¼€å§‹å¤„ç†
            processNode(element);

            // æœ€åæ¸…ç†ä»»ä½•å‰©ä½™çš„è¿ç»­ç©ºè¡Œ
            element.innerHTML = element.innerHTML.replace(/(<br\s*\/?>\s*){3,}/gi, '<br><br>');
            element.innerHTML = element.innerHTML.replace(/(<p>\s*<\/p>\s*){2,}/gi, '<p></p>');
        }

        function previewMarkdown() {
            const cardText = document.querySelector('.card-text');
            const renderedContent = document.querySelector('.rendered-content');
            const previewBtn = document.querySelector('.preview-btn');
            const generateBtn = document.querySelector('.generate-btn');
            
            // æ¸²æŸ“ Markdown
            let html = marked.parse(cardText.textContent);
            
            // å¤„ç†åˆ—è¡¨æ ‡ç­¾åçš„æ¢è¡Œ
            html = html
                .replace(/(<\/li>)\s*(?:\r\n|\n)?/g, '</li>')
                .replace(/(<\/ul>)\s*(?:\r\n|\n)?/g, '</ul>')
                .replace(/(<\/ol>)\s*(?:\r\n|\n)?/g, '</ol>')
                .replace(/(<li>)\s*(?:\r\n|\n)?/g, '<li>')
                .replace(/(<ul>)\s*(?:\r\n|\n)?/g, '<ul>')
                .replace(/(<ol>)\s*(?:\r\n|\n)?/g, '<ol>');
            
            renderedContent.innerHTML = html;
            
            // å¤„ç†å¤šä½™çš„ç©ºè¡Œ
            normalizeEmptyLines(renderedContent);
            
            // éšè—åŸæ–‡æœ¬ï¼Œæ˜¾ç¤ºæ¸²æŸ“åçš„å†…å®¹
            cardText.style.display = 'none';
            renderedContent.style.display = 'block';
            
            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            previewBtn.textContent = 'è¿”å›ç¼–è¾‘';
            generateBtn.style.display = 'block';
            
            // æ›´æ”¹é¢„è§ˆæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            previewBtn.onclick = function() {
                // æ¢å¤åŸå§‹æ˜¾ç¤ºçŠ¶æ€
                cardText.style.display = 'block';
                renderedContent.style.display = 'none';
                generateBtn.style.display = 'none';
                previewBtn.textContent = 'é¢„è§ˆæ¸²æŸ“æ•ˆæœ';
                previewBtn.onclick = previewMarkdown;
            };
            
            // ç¡®ä¿é«˜åº¦æ­£ç¡®
            adjustHeight();
        }

        async function generateImage() {
            const mainPage = document.getElementById('mainPage');
            const imagePage = document.getElementById('imagePage');
            const buttonGroup = document.querySelector('.button-group');
            const settingsArea = document.querySelector('.settings-area');
            const buttonArea = document.querySelector('.button-area');
            
            // è·å–è®¾å¤‡å®½åº¦å’Œè®¾ç½®æœ€å¤§å®½åº¦
            const deviceWidth = window.innerWidth;
            const maxWidth = Math.min(700, deviceWidth - 20); // å‡å»ä¸€äº›è¾¹è·
            
            try {
                // æš‚æ—¶éšè—è®¾ç½®åŒºåŸŸå’ŒæŒ‰é’®
                buttonGroup.style.display = 'none';
                settingsArea.style.display = 'none';
                buttonArea.style.background = 'transparent';
                buttonArea.style.border = 'none';
                
                // è·å–å†…å®¹åŒºåŸŸ
                const contentWrapper = document.querySelector('.content-wrapper');
                
                // ç§»é™¤è´Ÿè¾¹è·ï¼Œæ”¹ç”¨éšè—æŒ‰é’®åŒºåŸŸçš„æ–¹å¼
                buttonArea.style.display = 'none';  // æ–°å¢ï¼šç›´æ¥éšè—æ•´ä¸ªæŒ‰é’®åŒºåŸŸ
                contentWrapper.style.marginTop = '0';  // ä¿®æ”¹ï¼šä¸å†ä½¿ç”¨è´Ÿè¾¹è·
                
                const totalHeight = contentWrapper.getBoundingClientRect().height;
                
                // è®¾ç½®å®¹å™¨é«˜åº¦
                contentWrapper.style.height = `${totalHeight}px`;
                mainPage.style.height = `${totalHeight}px`;
                
                // ä½¿ç”¨html2canvasæ•è·é¡µé¢
                const canvas = await html2canvas(mainPage, {
                    backgroundColor: null,
                    scale: 2,
                    width: maxWidth, // è®¾ç½®ç”»å¸ƒå®½åº¦ä¸ºè®¾å¤‡å®½åº¦
                    height: totalHeight,
                    windowWidth: maxWidth, // è®¾ç½®çª—å£å®½åº¦ä¸ºè®¾å¤‡å®½åº¦
                    windowHeight: totalHeight,
                    useCORS: true,
                    onclone: function(clonedDoc) {
                        const clonedContent = clonedDoc.querySelector('.rendered-content');
                        if (clonedContent) {
                            clonedContent.style.color = '#c9d1d9';
                        }
                    }
                });
                
                // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡URL
                const imageUrl = canvas.toDataURL('image/png');
                
                // è®¾ç½®ç”Ÿæˆçš„å›¾ç‰‡æ ·å¼
                const generatedImage = document.querySelector('.generated-image');
                generatedImage.src = imageUrl;
                generatedImage.style.maxWidth = '100%'; // ç¡®ä¿å›¾ç‰‡ä¸ä¼šæº¢å‡º
                generatedImage.style.height = 'auto';   // ä¿æŒå®½é«˜æ¯”
                
                // åˆ‡æ¢æ˜¾ç¤º
                mainPage.style.display = 'none';
                imagePage.style.display = 'flex';
                
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                // æ¢å¤åŸå§‹æ˜¾ç¤ºçŠ¶æ€
                buttonArea.style.display = 'flex';  // æ–°å¢ï¼šæ¢å¤æŒ‰é’®åŒºåŸŸæ˜¾ç¤º
                buttonGroup.style.display = 'flex';
                settingsArea.style.display = 'flex';
                buttonArea.style.background = '#161b22';
                buttonArea.style.borderBottom = '1px solid #30363d';
                mainPage.style.height = 'auto';
                const contentWrapper = document.querySelector('.content-wrapper');
                contentWrapper.style.height = 'auto';
                contentWrapper.style.marginTop = '0';  // ç¡®ä¿æ¢å¤æ­£å¸¸è¾¹è·
            }
        }

        // é…ç½® marked é€‰é¡¹
        marked.setOptions({
            breaks: true,  // æ”¯æŒ GitHub é£æ ¼çš„æ¢è¡Œ
            gfm: true,    // å¯ç”¨ GitHub é£æ ¼çš„ Markdown
            headerIds: false,  // ç¦ç”¨æ ‡é¢˜ ID
            mangle: false,    // ç¦ç”¨æ ‡é¢˜ ID è½¬ä¹‰
            langPrefix: '',   // ä¸æ·»åŠ  language- å‰ç¼€
        });

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const text = document.querySelector('.card-text').textContent;
            const charCount = text.trim().length;
            const watermarkText = document.getElementById('watermarkInput').value || 'æ°´å°';
            const formattedCount = charCount.toLocaleString();
            document.querySelector('.stats').innerHTML = `<span>${watermarkText}</span><span>${formattedCount}å­—</span>`;
        }

        // ç›‘å¬æ°´å°è¾“å…¥å˜åŒ–
        document.getElementById('watermarkInput').addEventListener('input', function() {
            updateStats();
        });

        // åˆå§‹è°ƒæ•´é«˜åº¦å’Œæ›´æ–°ç»Ÿè®¡
        adjustHeight();
        updateStats();
    </script>
</body>
</html>